#!/usr/bin/env bash
here=$(pwd)

set -e

cd "$(dirname "${BASH_SOURCE[0]}")"
base_dir=$(pwd)

echo "Update submodules ..."
git submodule update --init --recursive

function command_exists {
  command -v "$1" >/dev/null 2>&1
}

if [ -n "${SHELL##*zsh*}" ]; then
  echo -e "To use ZSH as default shell please do:\n"
  echo "  chsh -s $(which zsh)"
  echo "  env zsh"
  echo "  source ~/.zshrc"
fi

echo ""

if command_exists pacman; then
  # Try to auto-install packages from list
  echo "Installing pacman packages ..."
  sudo pacman -Syu --needed - < pacman-pkglist-native.txt
  if ! command_exists trizen; then
    echo "Installing trizen to help with AUR packages..."
    cd /tmp
    git clone https://aur.archlinux.org/trizen.git
    cd trizen
    sudo makepkg -si
    cd "$base_dir"
  fi
  echo "Installing packages from AUR ..."
  trizen -S --needed - < pacman-pkglist-foreign.txt
fi

if command_exists pip; then
  # Try auto-install packages from list
  sudo pip install --upgrade pip
  pip install --upgrade --user -r python-pkglist.txt
fi

deps=(zsh thefuck xclip awk vint ag)
# Make sure to have commands available
for cmd in "${deps[@]}"; do
  if ! command_exists "$cmd"; then
    echo "  - command $cmd not found."
  fi
done

if ! command_exists vim && ! command_exists nvim; then
  echo "Neither vim, nor neovim were found."
fi

echo ""

# Install everything that is not a hidden directory or starts with + using GNU Stow
find . -maxdepth 1 -type d -not -iregex "^\.\(/[.+].*\)?" | sed "s~./~~" | xargs -L1 stow

cd "$here"
