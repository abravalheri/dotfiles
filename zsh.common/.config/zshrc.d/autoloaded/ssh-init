#!/usr/bin/env zsh
# vim: set foldmethod=marker filetype=zsh :

local SSH_ENV="$HOME/.ssh/environment"

ssh-agent-running() {
  (( ${+SSH_AUTH_SOCK} )) && [[ -f $SSH_AUTH_SOCK ]]
}

if ! ssh-agent-running; then
  if [[ -r "$SSH_ENV" ]]; then
    eval "$(< "$SSH_ENV")" >/dev/null
  fi

  if ! ssh-agent-running; then  # Still cannot connect to agent
    rm -rf "$SSH_ENV"
    (umask 066; ssh-agent -s -t 3600 > "$SSH_ENV")
    eval "$(< "$SSH_ENV")" >/dev/null
  fi
fi
echo -e "* ssh-agent is running\n"
